# Free Thought

## v0 Product Specification

## 1. Purpose

Build a macOS-first local Electron app for strategic reading with AI support. The app should help users think better while reading source documents, not replace reading.

The v0 design follows these principles:

- Foster critical thinking
- Enhance creativity
- Scaffold metacognition
- Improve recall
- Strengthen intentionality

This spec is grounded in the two source papers in `/docs` and the interview decisions captured for v0.

## 2. Target users

Primary v0 users:

- Solo researchers
- Students
- Analysts
- General readers doing serious reading/writing prep

## 3. Product goals for v0

The v0 must deliver these two outcomes:

1. Let users annotate documents with section anchors and optional paragraph/text-selection anchors.
2. Generate on-demand provocations while reading and while writing notes.

## 4. Non-goals for v0

- Drafting a new document inside the app
- Collaborative editing or shared workspaces
- OCR for scanned PDFs
- Embeddings/retrieval pipeline (deferred to post-v0)
- Web/mobile clients
- Cross-platform distribution (Windows/Linux)
- Export workflows (PDF/Markdown/Docx/JSON export)
- Citation generation in AI outputs
- Code-signing/notarization requirements for v0 distribution
- Auto-update system implementation

## 5. Supported platforms and file types

- Platform: macOS only
- Distribution target: local hobby/dev distribution on macOS only
- App menu bar name: `Free Thought`
- Input files:
  - `.pdf` (text PDFs only)
  - `.txt`
  - `.md`
- Document size limits:
  - `.pdf`: up to 50 pages
  - `.txt` / `.md`: up to 25,000 words

## 6. UX overview

Notes-first two-pane layout:

- Center pane: document reader (section-focused)
- Right sidebar: unified context feed (`All`, `Notes`, `Provocation`)
- No persistent left pane in reader mode; section navigation is exposed through top-bar controls and/or a transient outline drawer.
- Top navigation includes a `gear` settings entry that opens a modal.

Core interaction model:

1. User opens a workspace and imports files.
2. User opens a document and navigates by sections.
3. User writes notes attached to that section, paragraph, or text selection.
4. User explicitly requests a provocation for:
   - the current section while reading, or
   - a selected note or selected text while writing.
5. User resolves skipped reassignment items from `Unassigned notes` pinned in the right sidebar.

Provocations are optional, user-triggered (not automatic), and accumulate until deleted.

## 7. Functional requirements

## 7.1 Workspace

- Create/open local workspace folder.
- Use native macOS directory picker (`NSOpenPanel`) for workspace selection.
- On first use of each workspace, show a cloud-processing warning:
  - document text and notes may be sent to OpenAI APIs.
- Store all workspace data locally (SQLite + local files).
- Keep source documents in place (do not copy into workspace in v0).
- Store source file fingerprint metadata (`size`, `mtime`, `sha256`) for change detection.

## 7.2 Ingestion and sectioning

- Parse and index `.pdf` (text layer only), `.txt`, `.md`.
- Use native macOS file picker (`NSOpenPanel`) for file import.
- Hard reject unsupported/scanned PDFs with a clear message.
- Deterministic sectioning rules by file type:
  - `.md`: headings (`#`, `##`, etc.) and setext headings define section boundaries.
  - `.txt`: detect heading-like lines (`^\d+(\.\d+)*\s+`, short all-caps lines, or `Title:`-style labels); if none, split by paragraph into deterministic ~900-word sections (no overlap).
  - `.pdf`: use PDF outline/bookmarks first; else detect heading-like lines from extracted text; else fallback to deterministic 2-page section buckets.
- Thresholds and regex details for heading detection are fixed by `requirements.md` section 9 (`ND-001` through `ND-003`).
- Preserve source order for all sectioning outcomes; do not use fuzzy/AI segmentation in v0.
- Build deterministic section anchors per document revision:
  - `anchor_key = <normalized_heading_slug>#<ordinal>`
  - `ordinal` increments for repeated normalized headings in document order.
- `normalized_heading_slug` must be generated by:
  - Unicode NFKD normalization + diacritic stripping
  - lowercasing
  - replacing non-alphanumeric runs with `-`
  - collapsing duplicate `-` and trimming boundary `-`
  - fallback to `section` if empty
  - truncation to 80 characters
- `.txt`/`.md` 25,000-word limit must be deterministic:
  - `.md` word count is computed from plain text after removing Markdown syntax and code fences.
  - tokenization is Unicode letter/number based.
- Notes must attach to section IDs and remain anchored across app restarts.
- On re-import/re-index, remap notes only by exact `anchor_key` match.
- If no exact anchor match exists, mark notes `needs reassignment` and require manual reassignment.
- Do not use fuzzy/semantic remapping in v0.

## 7.3 Reader and notes

- Reader typography uses readability-oriented defaults (line length, line height, spacing, and contrast) across all supported file types.
- `.pdf` files render in a native macOS PDF viewing surface with selectable text, standard zoom, and smooth scrolling.
- If native `.pdf` rendering is unavailable, show fallback guidance while keeping section text and notes available.
- `.pdf` rendering uses a controllable renderer path (replacing iframe/embed path) so the app owns text-selection events and zoom/scroll state.
- In native `.pdf` view mode, selection-anchored note creation is supported directly from `.pdf` text selections.
- `.pdf` selections must map deterministically to normalized active-revision section-text offsets before note creation.
- `.pdf` renderer replacement must preserve zoom/scroll UX parity, meet section-navigation latency targets, and comply with Electron/CSP security baseline constraints.
- Create/edit/delete notes attached to a section, with optional paragraph/text-selection metadata.
- Notes are plain text for v0.
- Notes autosave on short debounce and on editor blur.
- Note editor must support focus, caret movement, text selection, and keyboard input for both new and existing notes.
- Selection-based note creation opens a non-destructive overlay composer anchored near the active selection.
- The selection note overlay uses a thin, single-line input for quick note entry before save.
- Show timestamp and section link metadata.
- For selection-anchored notes, show the selected text excerpt only (no paragraph ordinal or offset numbers).
- Show a top-right `x` delete control on each note card.
- Use one unified right-sidebar feed for notes + provocations, with sticky per-document filter chips (`All`, `Notes`, `Provocation`).
- `Unassigned notes` is pinned at the top of the right sidebar and remains actionable while reading.
- Footer always shows `Network: <state>`.
- Footer shows `Generating provocation from selected text...` with an animated indicator only while a selection-triggered provocation request is active.
- Footer does not show timestamp, source path, or generic `AI actions available` text.

## 7.4 Provocations

- Provocations are generated only when user clicks a button.
- Supported targets:
  - Current section (reading mode)
  - Specific note (writing mode)
  - Selected paragraph/text (writing mode)
- Output constraints:
  - Short critique/question/counterpoint style
  - Provocations accumulate per section and are shown in the unified feed ordered by document appearance
- User can generate additional provocations without replacing existing ones.
- User can delete any provocation from the list using a top-right `x` control.
- Provocations are not user-editable in v0.
- User can disable provocations per document.
- Provocation style precedence: request-level style selector overrides workspace default style.
- Selection-triggered provocation flow opens a style-selector overlay with workspace default preselected, dropdown alternatives, and a right-edge checkmark on the active style.

## 7.5 Electron security baseline

These controls are mandatory for v0:

- `contextIsolation: true`
- `sandbox: true`
- `nodeIntegration: false` in renderer processes
- `webSecurity: true`
- `enableRemoteModule: false`
- Preload-only API exposure via `contextBridge` (no direct Node access in renderer)
- IPC channel allowlist + runtime payload validation
- Strict Content Security Policy:
  - `default-src 'self'`
  - narrow `connect-src` for required API endpoints
- Deny untrusted window creation and navigation by default.
- Deny permission requests by default unless explicitly required.
- Store API keys in macOS Keychain only; never log secrets.

## 7.6 Settings

- OpenAI-backed configuration only in v0
  - Settings entry point: top-nav `gear` button opens modal settings panel
  - Settings must also be reachable from the native macOS app menu (`Command + ,`).
  - Reader settings edits are completed in this modal flow (no separate settings pane required in reader mode)
  - Auth mode selector:
    - `API key`
    - `Codex subscription login`
  - In `API key` mode, user provides OpenAI API key.
  - In `Codex subscription login` mode, user starts browser sign-in and completes session validation.
  - Generation routing is auth-mode specific:
    - `API key` mode calls OpenAI `/v1/responses` with Keychain-managed API key.
    - `Codex subscription login` mode calls Codex App Server transport (no direct OpenAI `/v1/responses` call with Codex session bearer token).
  - User selects generation model.
  - Settings modal includes: auth mode, generation model, workspace default provocation style, and `Re-import` action for the active document.
- Per-document toggle: provocations enabled/disabled.
- Workspace default provocation style selector: skeptical, creative, methodological.

## 8. AI behavior requirements

AI in this product is a thinking aid. It should challenge assumptions, not autocomplete entire outcomes.

Prompting requirements:

- Provocations must be non-authoritative and provisional.
- Provocations should stimulate reflection even when not directly actionable.
- Avoid imperative language like "you must".

Safety/quality requirements:

- Never fabricate file metadata.
- Keep outputs concise enough for in-context reading.
- Degrade gracefully on API failures with retry guidance.
- When offline, disable AI actions (provocation generation) and keep reading/notes available.
- In `Codex subscription login` mode, if runtime/permission errors block generation, return actionable fallback guidance to `API key` mode.

Runtime defaults:

- Timeout: 25s hard timeout per AI request.
- Retry policy: up to 2 retries for `429` and `5xx` with exponential backoff + jitter (base delays 500ms, 1500ms).
- Cancellation: request-scoped cancel using `requestId` and `AbortController`.
- Token budget:
  - Provocation: ~3000 input tokens, ~120 output tokens.
- Default models:
  - generation: `gpt-4.1-mini`

## 9. Architecture

## 9.1 App architecture

- Electron desktop app
  - Main process: window lifecycle, secure IPC, file access boundaries
  - Renderer: UI (notes-first two-pane reader experience, unified note/provocation feed actions)
  - Native OS bridge: macOS `NSOpenPanel` integration for directory/file selection and controllable native PDF surface integration for `.pdf` viewing + selection events
  - Local backend module/service: ingestion, deterministic context assembly, model calls, persistence

## 9.2 AI integration

Use an OpenAI-specific runtime in v0 with two auth adapters and two execution transports:

- `OpenAIClient` (API key mode transport)
  - `generateProvocation(input)`
  - `buildSectionContext(input)`
- `CodexAppServerClient` (Codex subscription mode transport)
  - request/response bridge to Codex App Server runtime for generation
  - request-scoped cancellation and timeout parity with OpenAI runtime policy defaults
- Auth adapters:
  - `ApiKeyAuthAdapter` (Keychain-backed)
  - `CodexSubscriptionAuthAdapter` (Codex app-server/browser-login-backed)

Routing rule:
- `API key` auth mode: use `OpenAIClient`.
- `Codex subscription login` auth mode: use `CodexAppServerClient`.

Keep internal boundaries clean so additional providers can be added later. Do not add non-OpenAI model providers in v0.

## 9.3 Context assembly approach

- No embedding retrieval in v0.
- Build AI context deterministically from local section order:
  - active section first
  - include up to one previous and one next section
  - assembly order: active, previous, next
  - deterministic clipping: keep active first, then previous, then next; truncate from tail of last included section to stay within budget
- Keep context narrow to reduce drift and latency.

## 9.4 Revision model

- Use immutable document revisions with `documents.current_revision_id` pointing to the active revision.
- Re-import/re-index executes atomically in one transaction:
  1. create revision record
  2. create sections for new revision
  3. remap notes by exact `anchor_key`
  4. queue unmatched notes as `needs reassignment`
  5. invalidate AI outputs tied to prior revision
  6. switch `current_revision_id`
- Unmatched notes are marked unassigned by setting `notes.section_id` to `NULL` and creating an open `note_reassignment_queue` row with old section metadata.
- Reassignment resolves the queue row and sets `notes.section_id` to a section in `documents.current_revision_id`.
- If transaction fails, rollback entire re-import/re-index.

## 9.5 IPC contracts

- IPC is allowlist-only and namespaced:
  - `workspace.open`, `workspace.create`
  - `document.import`, `document.reimport`, `document.locate`
  - `section.list`, `section.get`
  - `note.create`, `note.update`, `note.delete`, `note.reassign`
  - `ai.generateProvocation`, `ai.cancel`
  - `settings.get`, `settings.update`
  - `network.status`
- Response envelope is standardized:
  - success: `{ ok: true, data }`
  - failure: `{ ok: false, error: { code, message, details? } }`
- Validate IPC payloads against shared runtime schemas before handler execution.
- Minimum failure codes:
  - `E_VALIDATION`, `E_NOT_FOUND`, `E_CONFLICT`, `E_OFFLINE`, `E_PROVIDER`, `E_UNAUTHORIZED`, `E_INTERNAL`
  - `E_VALIDATION` includes field-level details.

Auth orchestration channels:

- `auth.status`
- `auth.loginStart`
- `auth.loginComplete`
- `auth.logout`
- `auth.switchMode`

## 10. Data model (SQLite + local files)

Minimum tables:

- `workspaces`
  - `id`, `root_path`, `cloud_warning_acknowledged_at`
- `documents`
  - `id`, `workspace_id`, `source_path`, `title`, `file_type`, `source_size_bytes`, `source_mtime_ms`, `source_sha256`, `current_revision_id`, `provocations_enabled`, `created_at`
- `document_revisions`
  - `id`, `document_id`, `revision_number`, `source_path`, `source_size_bytes`, `source_mtime_ms`, `source_sha256`, `created_at`
- `sections`
  - `id`, `document_id`, `revision_id`, `anchor_key`, `heading`, `order_index`, `text`, `page_start`, `page_end`
- `notes`
  - `id`, `document_id`, `section_id` (nullable when unassigned), `content`, `paragraph_ordinal` (nullable), `start_offset` (nullable), `end_offset` (nullable), `selected_text_excerpt` (nullable), `created_at`, `updated_at`
- `note_reassignment_queue`
  - `id`, `document_id`, `note_id`, `old_section_id`, `old_revision_id`, `new_revision_id`, `status`, `created_at`, `resolved_at`
- `provocations`
  - `id`, `document_id`, `revision_id`, `section_id`, `note_id` (nullable), `paragraph_ordinal` (nullable), `start_offset` (nullable), `end_offset` (nullable), `selected_text_excerpt` (nullable), `content`, `style`, `created_at`, `deleted_at` (nullable)
- `settings`
  - `id`, `workspace_id`, `auth_mode`, `generation_model`, `api_key_ref`
- `auth_sessions`
  - `id`, `workspace_id`, `provider` (`codex_chatgpt`), `status`, `account_label`, `last_validated_at`, `created_at`, `updated_at`
  - must not store bearer/refresh tokens

Local files:

- Original source files remain in place and are referenced by path
- Optional parsed text cache

## 11. Performance and limits

- Ingestion limits:
  - `.pdf` capped at 50 pages
  - `.txt` / `.md` capped at 25,000 words
- Target interactions:
  - open indexed section: near-instant local response
  - provocation generation: network-bound, show spinner + cancel
- User-facing footer shows connectivity (`Network: <state>`) and active generation status only while request is in-flight; AI latency display is debug-only.
- Cache AI outputs to avoid repeated cost on unchanged inputs.
- On any document re-import/re-index, invalidate all cached provocation outputs for that document revision.
- When offline, disable AI generation controls.
- Benchmark protocol:
  - v0 blocking smoke gate:
    - 20 warm-cache section navigations, report p50.
    - 10 provocation calls, report p50.
    - pass target: section navigation p50 `<200ms`; AI generation p50 `<8s`.
    - benchmark network profile: stable connection to OpenAI with no VPN/proxy, packet loss `<1%`, and median RTT `<150ms` during the benchmark run.
  - Hardening benchmark suite (non-blocking for initial hobby v0):
    - Hardware baseline: Apple Silicon macOS (M1/M2 class), 16GB RAM.
    - Fixture set: 12 representative documents across `.pdf`, `.txt`, `.md`, including near-limit files.
    - Section navigation benchmark: warm-cache run, 200 navigations, report p50/p90 from section-select to rendered section.
    - AI benchmark: 100 provocation calls, report p50/p90 latency.

## 12. Error handling

- Unsupported file type: actionable import error.
- Scanned PDF/no text layer: explicit OCR-not-supported message.
- Over-limit file: clear limit message (`50 pages` for `.pdf`, `25,000 words` for `.txt`/`.md`).
- Provider/API key errors: clear settings CTA.
- Codex runtime unavailable/inaccessible (including session-path permission issues): actionable fallback to `API key` mode.
- Codex-mode permission/scope denial: explicit `switch to API key mode` CTA.
- Timeout/rate limit: retry with backoff and user feedback.
- Offline: fail fast for AI actions and keep user in current reading/note context.
- Missing/moved source file: show `Locate file` and `Re-import` recovery actions.
- `.pdf` selection mapping failure: show recoverable guidance, allow retry, and preserve current reading/note context.

## 13. Acceptance criteria

v0 is complete when all are true:

1. User can import `.pdf` (text, up to 50 pages), `.txt`, and `.md` (up to 25,000 words).
2. User can navigate section-by-section and add notes (including optional paragraph/text-selection anchors) that remain attached after restart.
3. User can request provocations for sections, notes, and selected text on demand.
4. User can disable provocations for a specific document.
5. OpenAI API-key setup works with user-entered API key.
6. Workspace warning appears once per workspace before first cloud call.
7. Offline mode disables AI actions while preserving reading and note editing.
8. Reader uses a notes-first two-pane layout with unified right-sidebar feed and sticky per-document filter selection (`All`, `Notes`, `Provocation`).
9. Notes autosave on debounce/blur.
10. Re-import/re-index remaps notes only by exact `anchor_key`; unmatched notes are flagged for manual reassignment and remain visible in `Unassigned notes` until resolved.
11. Re-import/re-index invalidates all cached provocation outputs for that document revision.
12. When a source file is missing/moved, the app provides `Locate file` and `Re-import` actions.
13. Notes and provocations appear in one unified feed ordered by document appearance, and each item can be deleted with a visible `x` control.
14. Provocation style precedence follows request-level override then workspace default.
15. Electron security baseline controls in section 7.5 are enforced.
16. Sectioning and anchor generation behavior follows deterministic rules in section 7.2.
17. Re-import/re-index is atomic and revisioned per section 9.4.
18. IPC contracts and runtime validation follow section 9.5.
19. v0 blocking performance gate passes the smoke benchmark protocol in section 11.
20. Full p50/p90 benchmark suite is tracked for hardening completion.
21. No draft-document generation flow exists in UI.
22. Settings allows runtime switching between `API key` and `Codex subscription login` auth modes.
23. `Codex subscription login` can complete browser login and unlock provocation generation without API key entry.
24. Logging out of `Codex subscription login` immediately disables AI actions until re-authenticated or switched back to API key mode.
25. In `Codex subscription login` mode, provocation generation is routed through Codex App Server transport (not direct OpenAI `/v1/responses` bearer-token requests).
26. If Codex runtime is unavailable/inaccessible or scope-restricted, the app returns actionable guidance to switch to `API key` mode.
27. Workspace and import actions use native macOS pickers instead of manual absolute-path entry.
28. Note input remains editable (focus/select/type) during normal use and while AI requests are in flight.
29. Reader typography improvements are applied, and `.pdf` files use native macOS viewing behavior with fallback messaging when unavailable.
30. `.pdf` selection anchors are created directly from native `.pdf` text selections through deterministic selection-to-offset mapping, with recoverable guidance on unresolved mappings.
31. `Unassigned notes` are pinned above the unified feed in the right sidebar and remain actionable while reading.
32. Selection-triggered provocation flow opens a style-selector overlay with workspace default preselected, dropdown alternatives, and a right-edge active-style checkmark.
33. Reader footer always shows network state and conditionally shows selection-triggered provocation in-flight status with animated indicator.
34. Reader settings open from top-nav gear button and are edited in a modal with auth mode, generation model, and workspace default style controls.

## 14. Implementation phases

Phase 1: Foundation

- Workspace creation
- File import + section extraction
- SQLite schema and persistence
- Basic notes-first two-pane UI

Phase 2: AI core

- OpenAI client integration
- Deterministic context assembly from active/adjacent sections

Phase 3: Thought scaffolding

- Section notes
- On-demand provocations (section + note + selected-text target)
- Per-document provocation toggle

Phase 4: Hardening

- Error handling
- File size limit enforcement (50 pages for `.pdf`, 25,000 words for `.txt`/`.md`)
- UX polish for reading flow and latency states
